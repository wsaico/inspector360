import { Inspection, Equipment, Observation, INSPECTION_TYPES } from '@/types';

export function buildForAta057Html(opts: { inspection: Inspection; origin?: string }): string {
  const { inspection, origin } = opts;
  const eqList: Equipment[] = (inspection.equipment || []).sort((a, b) => (a.order_index ?? 0) - (b.order_index ?? 0));
  const observations: Observation[] = (inspection.observations || []).sort((a, b) => (a.order_index ?? 0) - (b.order_index ?? 0));
  const logoUrl = origin ? `${origin}/logo.png` : 'logo.png';
  const formatType = INSPECTION_TYPES[inspection.inspection_type] || inspection.inspection_type;
  const dateStr = (() => { const d = new Date(inspection.inspection_date); const yyyy = d.getFullYear(); const mm = String(d.getMonth() + 1).padStart(2, '0'); const dd = String(d.getDate()).padStart(2, '0'); return `${dd}/${mm}/${yyyy}`; })();
  function safe(text: any): string { return String(text ?? '').replace(/[<>]/g, (m) => (m === '<' ? '&lt;' : '&gt;')); }
  function renderSign(name?: string, url?: string | null) { if (!name && !url) return ''; return `<div class="sign">${url ? `<img src="${safe(url)}" alt="Firma" />` : `<div class="sign--placeholder"></div>`}<div class="sign__name">${safe(name || '')}</div></div>`; }
  const html = `<!doctype html><html lang="es"><head><meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>FOR-ATA-057 - ${safe(inspection.id || '')}</title><style>:root{--fg:#111;--muted:#666;--line:#e5e7eb;--primary:#0f766e}*{box-sizing:border-box}html,body{padding:0;margin:0;color:var(--fg);font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}.container{padding:16px}.header{display:flex;align-items:center;gap:16px;border-bottom:2px solid var(--line);padding-bottom:12px}.header img{height:40px;object-fit:contain}.header__titles{display:grid;gap:2px}.header__title{font-weight:700;font-size:16px}.header__subtitle{color:var(--muted)}.grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;margin-top:12px}.grid .field{border:1px solid var(--line);border-radius:6px;padding:8px}.field__label{font-size:12px;color:var(--muted)}.field__value{font-weight:600}.section{margin-top:16px}.section__title{font-weight:700;font-size:14px;padding:8px 0;border-bottom:2px solid var(--line)}table{width:100%;border-collapse:collapse;margin-top:8px}th,td{border:1px solid var(--line);padding:6px 8px;text-align:left;vertical-align:top}th{background:#f8fafc;font-weight:600}.muted{color:var(--muted)}.signs{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}.sign{display:grid;place-items:center;gap:6px;border:1px dashed var(--line);border-radius:6px;padding:8px;min-height:100px}.sign img{max-width:100%;max-height:80px;object-fit:contain}.sign--placeholder{width:100%;height:80px;background:#f1f5f9}.sign__name{font-weight:600}@media (max-width:900px){.grid{grid-template-columns:repeat(2,1fr)}.signs{grid-template-columns:1fr}}@page{size:A4 landscape;margin:10mm}</style></head><body><div class="container"><div class="header"><img src="${safe(logoUrl)}" alt="Logo" /><div class="header__titles"><div class="header__title">Formato FOR-ATA-057</div><div class="header__subtitle">Inspección de Equipos</div></div></div><div class="grid"><div class="field"><div class="field__label">Fecha</div><div class="field__value">${safe(dateStr)}</div></div><div class="field"><div class="field__label">Tipo</div><div class="field__value">${safe(formatType)}</div></div><div class="field"><div class="field__label">Inspector</div><div class="field__value">${safe(inspection.inspector_name)}</div></div><div class="field"><div class="field__label">Estación</div><div class="field__value">${safe(inspection.station)}</div></div></div><div class="section"><div class="section__title">Equipos</div><table><thead><tr><th>Código</th><th>Tipo</th><th>Marca</th><th>Modelo</th><th>Año</th><th>Serie</th><th>Motor</th><th>Descripción</th></tr></thead><tbody>${eqList.length===0?`<tr><td colspan="8" class="muted">Sin registros</td></tr>`:eqList.map((e)=>`<tr><td>${safe(e.code)}</td><td>${safe(e.type)}</td><td>${safe(e.brand)}</td><td>${safe(e.model)}</td><td>${safe(e.year)}</td><td>${safe(e.serial_number)}</td><td>${safe(e.motor_serial||'')}</td><td>${safe(e.description||'')}</td></tr>`).join('')}</tbody></table></div><div class="section"><div class="section__title">Observaciones</div><table><thead><tr><th>#</th><th>Equipo</th><th>Código Ítem</th><th>Observación Operador</th><th>Acción Mantenimiento</th></tr></thead><tbody>${observations.length===0?`<tr><td colspan="5" class="muted">Sin observaciones</td></tr>`:observations.map((o,idx)=>`<tr><td>${idx+1}</td><td>${safe(o.equipment_code)}</td><td>${safe(o.obs_id)}</td><td>${safe(o.obs_operator||'')}</td><td>${safe(o.obs_maintenance||'')}</td></tr>`).join('')}</tbody></table></div><div class="section"><div class="section__title">Firmas</div><div class="signs">${renderSign(inspection.inspector_name, eqList[0]?.inspector_signature_url || undefined)}${renderSign(inspection.supervisor_name, inspection.supervisor_signature_url || undefined)}${renderSign(inspection.mechanic_name, inspection.mechanic_signature_url || undefined)}</div></div></div><script>window.__forata057_ready = true</script></body></html>`;
  return html;
}
